<!DOCTYPE html>
<html>
<head>
    <title>Merit List Debug - CareerPath</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .debug-section { background: white; padding: 20px; margin: 20px 0; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .student-item { padding: 5px; border-bottom: 1px solid #eee; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; background: #007bff; color: white; }
    </style>
</head>
<body>
    <h1>ğŸ› Merit List Debug Tool</h1>
    
    <div class="debug-section">
        <h2>API Response Debug</h2>
        <button class="btn" onclick="testMeritAPI()">ğŸ” Test Merit API</button>
        <button class="btn" onclick="testDataProcessing()">âš™ï¸ Test Data Processing</button>
        
        <div id="apiDebugResults"></div>
    </div>
    
    <div class="debug-section">
        <h2>Student List (First 20)</h2>
        <div id="studentList"></div>
    </div>
    
    <div class="debug-section">
        <h2>Stream Distribution</h2>
        <div id="streamStats"></div>
    </div>

    <script>
        let allStudentsData = [];
        
        async function testMeritAPI() {
            const resultsDiv = document.getElementById('apiDebugResults');
            resultsDiv.innerHTML = '<p>â³ Loading...</p>';
            
            try {
                console.log('ğŸ” Testing API endpoint...');
                const response = await fetch('/api/merit', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                console.log('ğŸ“¡ Response status:', response.status);
                console.log('ğŸ“¡ Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('ğŸ“Š Raw API Response:', data);
                
                // Display debug info
                resultsDiv.innerHTML = `
                    <h3>âœ… API Response Successful</h3>
                    <pre>Response Status: ${response.status}
Response Type: ${typeof data}
Has 'success' property: ${data.hasOwnProperty('success')}
Success value: ${data.success}
Has 'data' property: ${data.hasOwnProperty('data')}
Data type: ${typeof data.data}
Is data array: ${Array.isArray(data.data)}
Data length: ${data.data ? data.data.length : 'undefined'}
Count property: ${data.count}
Response keys: ${Object.keys(data).join(', ')}</pre>
                `;
                
                // Process the data the same way the merit page should
                return processAPIData(data);
                
            } catch (error) {
                console.error('âŒ API test failed:', error);
                resultsDiv.innerHTML = `
                    <h3>âŒ API Test Failed</h3>
                    <pre>Error: ${error.message}
Stack: ${error.stack}</pre>
                `;
                return null;
            }
        }
        
        function processAPIData(data) {
            console.log('âš™ï¸ Processing API data...');
            let studentsArray = [];
            
            if (data && data.success === true && Array.isArray(data.data)) {
                console.log('âœ… Processing new API format, student count:', data.data.length);
                studentsArray = data.data;
            } else if (Array.isArray(data)) {
                console.log('âœ… Processing legacy array format, length:', data.length);
                studentsArray = data;
            } else {
                console.log('âŒ Unrecognized data format:', typeof data, data);
                return [];
            }
            
            // Process students same way as merit page
            allStudentsData = studentsArray.map((s, i) => ({
                _id: s._id || `student_${i}`,
                name: s.name || 'Unknown Student',
                email: s.email || '',
                marks: s.marks || 0,
                stream: s.stream || 'Science',
                preferredCourse: s.preferredCourse || s.course || 'Not specified',
                applicationId: s.applicationId || `APP${Date.now()}_${i}`,
                overallRank: i + 1,
                streamRank: i + 1,
                createdAt: s.createdAt || new Date()
            }));
            
            console.log('âœ… Processed students:', allStudentsData.length);
            return allStudentsData;
        }
        
        async function testDataProcessing() {
            const students = await testMeritAPI();
            if (!students || students.length === 0) {
                document.getElementById('studentList').innerHTML = '<p>âŒ No students processed</p>';
                return;
            }
            
            // Display first 20 students
            const studentListDiv = document.getElementById('studentList');
            studentListDiv.innerHTML = students.slice(0, 20).map((student, index) => `
                <div class="student-item">
                    ${index + 1}. <strong>${student.name}</strong> - ${student.marks}% - ${student.stream} - ${student.preferredCourse}
                    <br><small>ID: ${student.applicationId} | Email: ${student.email}</small>
                </div>
            `).join('');
            
            // Calculate stream distribution
            const streamCounts = {};
            students.forEach(student => {
                streamCounts[student.stream] = (streamCounts[student.stream] || 0) + 1;
            });
            
            document.getElementById('streamStats').innerHTML = `
                <h3>ğŸ“Š Stream Distribution (Total: ${students.length})</h3>
                ${Object.entries(streamCounts).map(([stream, count]) => 
                    `<p><strong>${stream}</strong>: ${count} students</p>`
                ).join('')}
            `;
        }
        
        // Auto-run tests on page load
        window.onload = function() {
            console.log('ğŸ› Debug page loaded, running tests...');
            setTimeout(testDataProcessing, 1000);
        };
    </script>
</body>
</html>